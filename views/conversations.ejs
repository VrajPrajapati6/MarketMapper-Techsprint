<% layout('layouts/boilerplate') -%>

<style>
  .search-wrapper {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 50px;
    padding: 10px 20px;
    margin-bottom: 30px;
    transition: 0.3s;
  }
  .search-wrapper:focus-within {
    border-color: #a855f7;
    background: rgba(168, 85, 247, 0.05);
  }
  .search-input {
    background: transparent;
    border: none;
    color: white;
    width: 100%;
    outline: none;
  }
  .chat-row {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    align-items: center;
    text-decoration: none;
    margin-bottom: 12px;
    transition: 0.3s;
  }
  .chat-row:hover {
    background: rgba(168, 85, 247, 0.08);
    border-color: rgba(168, 85, 247, 0.3);
    transform: translateY(-2px);
  }
  .avatar-md {
    width: 55px;
    height: 55px;
    border-radius: 18px;
    object-fit: cover;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
</style>

<div class="container inbox-container py-5 mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-white fw-bold m-0">Conversations</h3>
      </div>

      <form action="/conversations" method="GET" id="searchForm" class="search-wrapper d-flex align-items-center">
        <i class="fa-solid fa-magnifying-glass text-secondary me-3"></i>
        <input 
          type="text" 
          name="search" 
          id="searchInput"
          class="search-input" 
          placeholder="Search by name..." 
          value="<%= search %>"
          autocomplete="off"
        >
        <% if(search) { %>
          <a href="/conversations" class="text-secondary ms-2"><i class="fa-solid fa-xmark"></i></a>
        <% } %>
      </form>

      <div id="connectionList">
        <% if(connections && connections.length > 0) { %> 
          <% connections.forEach(friend => { %>
            <a href="/chat/<%= friend._id %>" class="chat-row">
              <img src="<%= friend.image || 'https://ui-avatars.com/api/?name=' + friend.username %>" class="avatar-md me-4" />
              <div class="flex-grow-1">
                <h6 class="text-white fw-bold mb-1"><%= friend.username %></h6>
                <p class="text-secondary small mb-0">
                  Click to resume business discussion...
                </p>
              </div>
              <i class="fa-solid fa-chevron-right text-secondary opacity-50"></i>
            </a>
          <% }) %> 
        <% } else { %>
          <div class="glass-panel text-center py-5 rounded-4" style="background: rgba(17, 17, 18, 0.8); border: 1px solid rgba(255,255,255,0.08);">
            <i class="fa-regular fa-comment-dots fs-1 text-secondary opacity-25 mb-3"></i>
            <p class="text-secondary">
              <%= search ? `No connections found matching "${search}"` : "No active connections. Connect with businesses to start chatting." %>
            </p>
            <% if(search) { %>
              <a href="/conversations" class="btn btn-sm btn-outline-purple rounded-pill px-4 mt-2">View All</a>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
  const searchInput = document.getElementById('searchInput');
  const searchForm = document.getElementById('searchForm');

  // Logic to search as you type
  searchInput.addEventListener('input', (e) => {
    // We use a timeout so it doesn't refresh the page on every single letter instantly (Debouncing)
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(() => {
      searchForm.submit();
    }, 500); // Wait 500ms after user stops typing to submit
  });

  // Keep focus and put cursor at the end of the text after page refresh
  if (searchInput.value.length > 0) {
    searchInput.focus();
    const val = searchInput.value;
    searchInput.value = '';
    searchInput.value = val;
  }
</script>