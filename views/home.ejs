<% layout('layouts/boilerplate') -%>

<style>
  :root {
    --bg-body: #050505;
    --card-bg: rgba(20, 20, 20, 0.6);
    --card-border: rgba(255, 255, 255, 0.08);
    --purple-pink-text: linear-gradient(to right, #a855f7, #ec4899, #6366f1);
    --hero-gradient: linear-gradient(135deg, #0a0a0c 0%, #111115 100%);
    --accent-purple: #a855f7;
    --accent-green: #10b981;
  }

  body {
    background-color: var(--bg-body);
    background-image: radial-gradient(
      circle at top center,
      rgba(168, 85, 247, 0.1),
      transparent 60%
    );
  }

  .dashboard-container {
    max-width: 1300px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .top-layout-grid {
    display: grid;
    grid-template-columns: 1.8fr 1fr;
    gap: 25px;
    margin-bottom: 40px;
  }

  .glass-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 28px;
    padding: 30px;
    backdrop-filter: blur(20px);
    transition: all 0.4s ease;
  }

  .glass-card:hover {
    transform: translateY(-5px);
    background: rgba(30, 30, 30, 0.8);
    border-color: rgba(168, 85, 247, 0.3);
  }

  .hero-section {
    background: var(--hero-gradient);
    border: 1px solid rgba(168, 85, 247, 0.2);
    padding: 50px;
  }

  .text-vanguard {
    background: var(--purple-pink-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 800;
  }

  /* Collaboration Hub Styles */
  .collaboration-hub {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .contract-mini-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 18px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: 0.3s;
  }

  .contract-mini-card:hover {
    background: rgba(168, 85, 247, 0.08);
  }

  .status-badge {
    font-size: 0.65rem;
    padding: 4px 10px;
    border-radius: 50px;
    text-transform: uppercase;
    font-weight: 800;
  }

  .cta-button {
    background: linear-gradient(90deg, #a855f7, #ec4899);
    color: #fff;
    padding: 12px 30px;
    border-radius: 50px;
    font-weight: 700;
    text-decoration: none;
    display: inline-block;
    transition: 0.3s;
    font-size: 0.9rem;
  }

  .view-all-btn {
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #94a3b8;
    padding: 10px;
    border-radius: 15px;
    text-align: center;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 600;
    transition: 0.3s;
  }

  .view-all-btn:hover {
    border-color: #a855f7;
    color: #fff;
    background: rgba(168, 85, 247, 0.1);
  }

  /* Updated icon square for perfect centering */
  .icon-square {
    width: 40px;
    height: 40px;
    min-width: 40px;
    border-radius: 12px;
    display: inline-flex; /* Use inline-flex for better child centering */
    align-items: center; /* Vertical center */
    justify-content: center; /* Horizontal center */
    background: rgba(168, 85, 247, 0.1);
    color: #a855f7;
    font-size: 1.1rem;
  }

  /* Ensure the mini-card handles vertical alignment of text and icon together */
  .contract-mini-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 18px;
    padding: 12px 16px; /* Balanced padding */
    display: flex;
    align-items: center; /* Key: Aligns icon square with the text block vertically */
    gap: 15px;
    transition: 0.3s;
  }

  /* Fix any default margins on the briefcase icon itself */
  .contract-mini-card i {
    margin: 0;
    padding: 0;
    display: block;
  }

  /* Electric Blue Theme for Analysis Button */
  .btn-analysis-blue {
    background: linear-gradient(90deg, #06b6d4, #3b82f6) !important;
    color: #ffffff !important;
    box-shadow: 0 0 20px rgba(6, 182, 212, 0.3) !important;
    border: none !important;
  }

  .btn-analysis-blue:hover {
    transform: translateY(-3px) scale(1.05);
    background: linear-gradient(90deg, #22d3ee, #2563eb) !important;
    box-shadow: 0 0 35px rgba(34, 211, 238, 0.5) !important;
    color: #ffffff !important;
  }

  /* Ensure the icon within the blue button is white */
  .btn-analysis-blue i {
    color: #ffffff !important;
  }

  /* Consistent CTA Button Styling */
  .cta-button {
    padding: 12px 28px;
    border-radius: 50px;
    font-weight: 700;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  /* ðŸ“± MOBILE VIEW OPTIMIZATIONS (DOES NOT AFFECT DESKTOP) */
  @media (max-width: 992px) {
    /* 1. Header & Navigation Fix */
    .navbar-nav {
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 20px;
      margin-top: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      gap: 12px; /* Adds breathing room between items */
    }

    .nav-link {
      text-align: center;
      width: 100%;
      padding: 12px !important;
    }

    /* 2. Score Ring Centering & Resizing */
    .score-circle-wrapper {
      width: 140px; /* Scaled down for mobile */
      height: 140px;
      margin: 15px auto !important; /* Forces horizontal centering */
    }

    .score-value .number {
      font-size: 2.5rem; /* Prevents text overflow */
    }

    /* 3. Button Stacking (Mobile UX) */
    .hero-section .d-flex.gap-3 {
      flex-direction: column; /* Stacks buttons so they are easier to tap */
      gap: 10px !important;
    }

    .cta-button,
    .btn-outline-light {
      width: 100%;
      justify-content: center;
    }

    /* 4. Grid Adjustments */
    .top-layout-grid {
      grid-template-columns: 1fr; /* Stacks Hero and Reputation Card */
      gap: 20px;
    }

    .glass-card {
      padding: 20px; /* Saves screen real estate */
    }

    .hero-section h1 {
      font-size: 2.2rem; /* Avoids text clipping on small phones */
      text-align: center;
    }
  }

  .score-circle-wrapper {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 0 auto;
  }

  .score-svg {
    transform: rotate(
      -90deg
    ); /* Ensures the circle starts filling from the top */
    width: 100%;
    height: 100%;
  }

  .circle-bg {
    fill: none;
    stroke: rgba(255, 255, 255, 0.05); /* Very faint background track */
    stroke-width: 10;
  }

  .circle-progress {
    fill: none;
    stroke-width: 10;
    stroke-linecap: round;
    /* 2 * PI * Radius(40) is approx 251.2 */
    stroke-dasharray: 251.2;
    stroke-dashoffset: 251.2; /* Completely hollow by default */
    transition: stroke-dashoffset 1.5s cubic-bezier(0.19, 1, 0.22, 1);
  }

  /* FILL EFFECT ON HOVER: 251.2 - (251.2 * 0.78) = 55.26 */
  .reputation-card:hover .circle-progress {
    stroke-dashoffset: 55.26 !important;
  }

  .score-value {
    position: absolute;
    top: 55%; /* Slightly adjusted for better visual centering */
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }

  .score-value .number {
    font-size: 3.5rem;
    font-weight: 800;
    color: #ffffff;
    line-height: 0.8;
  }

  .score-value .percent {
    color: #6366f1;
    font-size: 0.75rem;
    font-weight: 800;
    letter-spacing: 2px;
  }
  /* Custom Divider for Spacing */
  .custom-divider {
    width: 80%; /* Don't touch the edges of the card */
    border: 0;
    border-top: 1px solid rgba(255, 255, 255, 0.1); /* Subtle white glow */
    opacity: 1;
    margin-top: 25px !important; /* Space above the line */
    margin-bottom: 25px !important; /* Space below the line */
  }

  /* Ensure the text below is clean and centered */
  .profile-highlight-box h6 {
    font-size: 1.05rem;
    letter-spacing: 0.5px;
    line-height: 1.2;
  }

  /* Hover refinement */
  .reputation-card:hover .custom-divider {
    border-top-color: rgba(168, 85, 247, 0.3); /* Line glows purple on hover */
    transition: 0.4s ease;
  }
  /* Custom styling to increase the Elite Level size */
  .elite-badge-premium {
    font-size: 0.9rem !important; /* Increased from default small size */
    letter-spacing: 1.5px !important; /* More space between letters for premium feel */
    padding: 10px 25px !important; /* Increased padding for a larger "capsule" look */
    border: 1px solid rgba(168, 85, 247, 0.2); /* Subtle border to define the shape */
    transition: all 0.4s ease;
  }

  /* Fix the icon size to match the larger text */
  .elite-badge-premium i {
    font-size: 1rem;
  }

  /* Hover effect to make it pop */
  .reputation-card:hover .elite-badge-premium {
    background: rgba(168, 85, 247, 0.25) !important;
    transform: scale(1.05); /* Slight grow effect on hover */
    box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
  }
</style>

<div class="dashboard-container">
  <canvas
    id="glitterCanvas"
    style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    "
  ></canvas>

  <div class="top-layout-grid">
    <div class="glass-card hero-section">
      <h6
        class="text-secondary text-uppercase mb-2"
        style="letter-spacing: 3px"
      >
        Network Active
      </h6>
      <h1 class="display-4 fw-bold mb-4 text-white">
        Welcome, <br /><span class="text-vanguard"
          ><%= currUser.username %></span
        >
      </h1>
      <p class="text-secondary lead mb-4" style="max-width: 500px">
        Your gateway to elite B2B partnerships, automated contracts, and
        strategic business growth.
      </p>
      <div class="d-flex gap-3 mt-2">
        <a href="/analysis" class="cta-button btn-analysis-blue">
          Analysis <i class="fa-solid fa-chart-line ms-2"></i>
        </a>

        <a href="/businesses" class="cta-button">
          Explore Partners <i class="fa-solid fa-handshake ms-2"></i>
        </a>

        <a
          href="/posts"
          class="btn btn-outline-light rounded-pill px-4 d-flex align-items-center"
          style="border-color: rgba(255, 255, 255, 0.1)"
        >
          Community Feed
        </a>
      </div>
    </div>

    <div class="glass-card reputation-card h-100">
      <div class="d-flex align-items-center mb-4">
        <div
          class="icon-square text-white"
          style="background: rgba(168, 85, 247, 0.1); color: #a855f7"
        >
          <i class="fa-solid fa-bolt-lightning"></i>
        </div>
        <span class="ms-3 text-secondary text-uppercase fw-bold small"
          >Reputation Score</span
        >
      </div>

      <div class="score-container">
        <div class="score-circle-wrapper">
          <svg class="score-svg" viewBox="0 0 100 100">
            <defs>
              <linearGradient
                id="scoreGradient"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="100%"
              >
                <stop
                  offset="0%"
                  style="stop-color: #a855f7; stop-opacity: 1"
                />
                <stop
                  offset="50%"
                  style="stop-color: #6366f1; stop-opacity: 1"
                />
                <stop
                  offset="100%"
                  style="stop-color: #ec4899; stop-opacity: 1"
                />
              </linearGradient>
            </defs>
            <circle class="circle-bg" cx="50" cy="50" r="40"></circle>
            <circle
              class="circle-progress"
              cx="50"
              cy="50"
              r="40"
              stroke="url(#scoreGradient)"
            ></circle>
          </svg>

          <div class="score-value">
            <span class="number"><%= score %></span>
            <span class="percent">SCORE</span>
          </div>
        </div>
      </div>

      <div class="mt-auto text-center pb-4">
        <div
          class="badge bg-purple-dim text-purple px-4 py-2 rounded-pill elite-badge-premium mb-1"
        >
          <i class="fa-solid fa-shield-check me-2"></i> LEVEL: <%= score >= 80 ?
          'ELITE' : score >= 50 ? 'RISING STAR' : 'PROBATION' %>
        </div>

        <hr class="mx-auto my-4 custom-divider" />

        <div class="profile-highlight-box">
          <h6 class="text-white fw-bold mb-0 px-3">
            Strategic Visionary & Top Collaborator
          </h6>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-lg-8">
      <div class="glass-card collaboration-hub h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="text-white fw-bold m-0">Recent Collaborations</h5>
          <i class="fa-solid fa-file-signature text-purple"></i>
        </div>

        <div class="flex-grow-1">
          <% if(typeof contracts !== 'undefined' && contracts &&
          contracts.length > 0) { contracts.slice(0, 3).forEach(contract => { %>
          <div class="contract-mini-card mb-2">
            <div class="icon-square">
              <i class="fa-solid fa-briefcase"></i>
            </div>
            <div class="flex-grow-1 overflow-hidden">
              <p class="text-white small fw-bold mb-0 text-truncate">
                <%= contract.title %>
              </p>
              <span
                class="status-badge bg-success bg-opacity-10 text-success"
                style="font-size: 0.6rem; letter-spacing: 0.5px"
              >
                ACTIVE DEAL
              </span>
            </div>
          </div>
          <% }) } else { %>
          <div class="text-center py-4 opacity-50">
            <p class="small text-secondary mb-0">No active contracts found.</p>
          </div>
          <% } %>
        </div>

        <a href="/contracts" class="view-all-btn mt-2">
          View All Contracts <i class="fa-solid fa-arrow-right ms-2"></i>
        </a>
      </div>
    </div>

    <div class="col-lg-4">
      <div
        class="glass-card h-100 bg-purple-dim border-purple"
        style="
          background: linear-gradient(rgba(168, 85, 247, 0.05), transparent);
        "
      >
        <h5 class="text-white fw-bold mb-3">B2B Motive</h5>
        <p class="text-secondary small mb-4">
          MarketMapper isn't just about data. It's about finding the right
          partner to act on that data. Connect, negotiate, and sign deals in one
          secure ecosystem.
        </p>
        <div class="d-flex align-items-center gap-3 mb-3">
          <div
            class="rounded-circle bg-dark d-flex align-items-center justify-content-center"
            style="width: 35px; height: 35px"
          >
            <i class="fa-solid fa-check text-success small"></i>
          </div>
          <span class="text-white small fw-bold">Verified Partners</span>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div
            class="rounded-circle bg-dark d-flex align-items-center justify-content-center"
            style="width: 35px; height: 35px"
          >
            <i class="fa-solid fa-shield-halved text-info small"></i>
          </div>
          <span class="text-white small fw-bold">Secure Contracts</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-12">
      <div class="glass-card h-100">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="text-white fw-bold m-0">
            New Analysed Business Repository
          </h4>
          <a
            href="/history"
            class="text-secondary small text-decoration-none hover-purple"
            >Full History</a
          >
        </div>

        <div class="repository-list">
          <% if(reports && reports.length > 0) {reports.slice(0,
          3).forEach(report => { %>
          <div
            class="list-row border-bottom border-secondary border-opacity-10 py-3 d-flex justify-content-between align-items-center"
          >
            <div class="d-flex align-items-center">
              <div
                class="icon-square me-3"
                style="background: rgba(59, 130, 246, 0.1); color: #3b82f6"
              >
                <i class="fa-solid fa-chart-pie"></i>
              </div>
              <div>
                <h6 class="text-white mb-0 fw-bold"><%= report.title %></h6>
                <small class="text-secondary"
                  >Analysis generated on <%= report.createdAt.toDateString()
                  %></small
                >
              </div>
            </div>
            <a
              href="/analysis/rerun?query=<%= encodeURIComponent(report.title) %>"
              class="btn btn-sm btn-outline-purple rounded-pill px-3"
              >View</a
            >
          </div>
          <% })} else { %>
          <p class="text-secondary text-center py-4">
            No analysis reports available.
          </p>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const canvas = document.getElementById("glitterCanvas");
  const ctx = canvas.getContext("2d");

  let particles = [];
  const colors = ["#a855f7", "#ec4899", "#6366f1", "#3b82f6"];

  function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    particles = [];
    for (let i = 0; i < 90; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 4 + 1,
        dx: (Math.random() - 0.5) * 0.8,
        dy: (Math.random() - 0.5) * 0.8,
        color: colors[Math.floor(Math.random() * colors.length)],
      });
    }
  }

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach((p) => {
      // Draw 3D-like shaded sphere
      let gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
      gradient.addColorStop(0, "white");
      gradient.addColorStop(0.4, p.color);
      gradient.addColorStop(1, "transparent");

      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();

      // Movement logic
      p.x += p.dx;
      p.y += p.dy;

      // Bounce off edges
      if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
    });
    requestAnimationFrame(animate);
  }

  window.addEventListener("resize", init);
  init();
  animate();
</script>
