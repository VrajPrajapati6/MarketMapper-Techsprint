<% layout('layouts/boilerplate') -%>

<style>
    body {
      background: #050505 !important;
      overflow-x: hidden;
      color: #fff;
    }

    .profile-wrapper {
      padding: 50px 0 60px;
      min-height: 100vh;
      background: radial-gradient(
        circle at top center,
        rgba(168, 85, 247, 0.12),
        transparent 70%
      );
    }

    .glass-panel {
      background: rgba(17, 17, 18, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 28px;
      padding: 35px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* Avatar & Identity Styling */
    .avatar-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 20px;
    }

    .avatar-main {
      width: 130px;
      height: 130px;
      border-radius: 40px;
      object-fit: cover;
      border: 2px solid #a855f7;
      padding: 5px;
      background: rgba(168, 85, 247, 0.1);
    }

    .status-indicator {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      background: #22c55e;
      border: 3px solid #050505;
      border-radius: 50%;
    }

    /* Typography & Labels */
    .detail-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #a855f7;
      font-weight: 800;
      margin-bottom: 8px;
      display: block;
    }

    .info-pill {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.07);
      padding: 12px 18px;
      border-radius: 16px;
      color: #cbd5e1;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Accordion Customization */
    .accordion-button {
      background: rgba(255, 255, 255, 0.03) !important;
      color: #fff !important;
      border: 1px solid rgba(255, 255, 255, 0.07) !important;
      border-radius: 18px !important;
      padding: 18px;
      font-weight: 600;
    }

    .accordion-button:not(.collapsed) {
      border-color: #a855f7 !important;
      background: rgba(168, 85, 247, 0.05) !important;
      box-shadow: none;
    }

    .accordion-item {
      background: transparent !important;
      border: none !important;
      margin-bottom: 15px;
    }

    .btn-purple-action {
      background: #a855f7;
      color: white;
      border-radius: 50px;
      font-weight: 700;
      transition: 0.3s;
      border: none;
    }

    .btn-purple-action:hover {
      background: #9333ea;
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
      transform: translateY(-2px);
    }
    .btn-glass-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50px;
      font-weight: 600;
      transition: 0.3s;
    }

    .btn-glass-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #a855f7;
      border-color: #a855f7;
      transform: translateY(-2px);
    }
    .reputation-mini-badge {
    background: rgba(168, 85, 247, 0.1);
    color: #a855f7;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 800;
    border: 1px solid rgba(168, 85, 247, 0.2);
    letter-spacing: 0.5px;
    box-shadow: 0 0 10px rgba(168, 85, 247, 0.1);
  }

  .profile-avatar-container img {
    border: 2px solid <%= score >= 80 ? '#a855f7' : '#3b82f6' %>;
    box-shadow: 0 0 20px <%= score >= 80 ? 'rgba(168, 85, 247, 0.3)' : 'rgba(59, 130, 246, 0.3)' %>;
  }

  .reputation-mini-badge {
    background: rgba(168, 85, 247, 0.1);
    color: #a855f7;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 800;
    border: 1px solid rgba(168, 85, 247, 0.2);
    letter-spacing: 0.5px;
    box-shadow: 0 0 10px rgba(168, 85, 247, 0.1);
  }
  
  /* Make the avatar border glow based on Elite status */
  .profile-avatar-container img {
    border: 2px solid <%= score >= 80 ? '#a855f7' : '#3b82f6' %>;
    box-shadow: 0 0 20px <%= score >= 80 ? 'rgba(168, 85, 247, 0.3)' : 'rgba(59, 130, 246, 0.3)' %>;
  }
</style>

<div class="profile-wrapper">
  <canvas
    id="glitterCanvas"
    style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    "
  ></canvas>
  <div class="container">
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="glass-panel text-center">
          <div class="avatar-wrapper">
            <img src="<%= user.image %>" class="avatar-main" alt="Profile" />
            <div class="status-indicator"></div>
          </div>

          <h3 class="fw-bold text-white mb-1"><%= user.username %></h3>
          <p class="text-secondary small mb-4">
            ID: #<%= user._id.toString().slice(-6).toUpperCase() %>
          </p>

          <div class="d-flex justify-content-center align-items-center gap-2">
            <div class="reputation-mini-badge">
              <i class="fa-solid fa-bolt-lightning me-1"></i>
              REPUTATION: <%= score %>
            </div>
            <span class="text-purple small fw-bold">| <%= score >= 80 ? 'ELITE' : 'RISING' %></span>
          </div>

          <div class="text-start mt-4">
            <div class="mb-3">
              <span class="detail-label">Identity Email</span>
              <div class="info-pill">
                <i class="fa-regular fa-envelope text-purple"></i>
                <%= user.email %>
              </div>
            </div>

            <div class="mb-4">
              <span class="detail-label">Member Since</span>
              <div class="info-pill">
                <i class="fa-regular fa-calendar-check text-purple"></i>
                <%= new Date(user.createdAt).toLocaleDateString('en-GB', { day:
                'numeric', month: 'short', year: 'numeric' }) %>
              </div>
            </div>
          </div>

          <div class="d-grid gap-2 mt-4">
            <% if (currUser && currUser._id.equals(user._id)) { %>
            <a href="/profile/edit" class="btn btn-purple-action py-3"
              >Edit Profile</a
            >
            <a
              href="/logout"
              class="btn btn-link text-danger text-decoration-none fw-bold small mt-2"
              >Logout Session</a
            >

            <% } else { %>
            <div class="row g-2 mt-1">
              <div class="col-6">
                <% if (currUser.connections.some(c => c._id.equals(user._id))) {
                %>
                <button class="btn btn-success w-100 py-2" disabled>
                  <i class="fa-solid fa-user-check me-2"></i>Connected
                </button>
                <% } else if (currUser.sentRequests.some(r => r ===
                user._id.toString() || (r._id && r._id.equals(user._id)))) { %>
                <button class="btn btn-warning w-100 py-2" disabled>
                  <i class="fa-solid fa-clock me-2"></i>Pending
                </button>
                <% } else { %>
                <a
                  href="/connect/add/<%= user._id %>"
                  class="btn btn-glass-secondary w-100 py-2 text-decoration-none"
                >
                  <i class="fa-solid fa-user-plus me-2"></i>Connect
                </a>
                <% } %>
              </div>
              <div class="col-6">
                <a
                  href="/agreement/<%= user._id %>"
                  class="btn btn-glass-secondary w-100 py-2 text-decoration-none"
                >
                  <i class="fa-solid fa-handshake me-2"></i>Collaborate
                </a>
              </div>
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <a href="/connections" class="text-decoration-none">
          <div
            class="mb-4 p-3 rounded-4 bg-black bg-opacity-25 border border-white border-opacity-5"
          >
            <div class="row align-items-center">
              <div class="col-8">
                <p class="cnn text-secondary small mb-1">Active Connections</p>
                <h4 class="cnn text-white fw-bold mb-0">
                  <%= user.connections.length %>
                </h4>
              </div>
              <div class="col-4 text-end">
                <% if(user.pendingRequests.length > 0) { %>
                <span class="badge bg-danger rounded-pill small">
                  <%= user.pendingRequests.length %> New
                </span>
                <% } %>
              </div>
            </div>
          </div>
        </a>
        <div class="glass-panel mb-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold m-0">
              <i class="fa-solid fa-store me-2" style="color: #a855f7"></i>My
              Businesses
            </h5>

            <% if (currUser && currUser._id.equals(user._id)) { %>
            <a
              href="/businessAdd"
              class="btn btn-sm btn-outline-light rounded-pill px-3"
            >
              Add New
            </a>
            <% } %>
          </div>

          <% if(user.businesses && user.businesses.length > 0) { %>
          <div class="accordion" id="bizAccordion">
            <% user.businesses.forEach((biz, i) => { %>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#biz-<%= i %>"
                >
                  <%= biz.name %>
                  <span
                    class="badge ms-3 bg-dark opacity-75 font-monospace"
                    style="font-size: 0.6rem"
                    ><%= biz.category %></span
                  >
                </button>
              </h2>
              <div
                id="biz-<%= i %>"
                class="accordion-collapse collapse"
                data-bs-parent="#bizAccordion"
              >
                <div
                  class="accordion-body border border-top-0 border-white border-opacity-10 rounded-bottom-4 bg-black bg-opacity-25 p-4"
                >
                  <div class="row g-3">
                    <div class="col-md-6">
                      <span class="detail-label">Operating Scale</span>
                      <p class="text-white mb-1">
                        <%= biz.stats.employeeCount %> Employees | <%=
                        biz.stats.revenueRange %>
                      </p>

                      <span class="detail-label mt-2 d-block"
                        >Years in Business</span
                      >
                      <p class="text-white mb-0">
                        <%= biz.stats.yearsInBusiness %> Years
                      </p>
                    </div>

                    <div class="col-md-6 text-md-end">
                      <span class="detail-label">Resources</span>
                      <p class="text-white mb-0">
                        Product / Service: <%= biz.resources.pos %> | Delivery
                        Options: <%= biz.resources.hasDelivery %>
                      </p>
                    </div>
                    <div
                      class="col-12 border-top border-white border-opacity-10 pt-3 mt-3"
                    >
                      <span class="detail-label">Location Address</span>
                      <p class="text-secondary small mb-0">
                        <i class="fa-solid fa-location-dot me-2 text-danger"></i
                        ><%= biz.location.address %>
                      </p>
                    </div>
                  </div>
                  <div class="mt-4">
                    <a
                      href="/businesses/<%= biz._id %>/edit"
                      class="btn btn-sm btn-outline-secondary rounded-pill px-4"
                      >Manage Details</a
                    >
                  </div>
                </div>
              </div>
            </div>
            <% }) %>
          </div>
          <% } else { %>
          <div
            class="text-center py-5 border border-dashed border-secondary rounded-4"
          >
            <p class="text-secondary mb-0">
              No business entities mapped to your profile.
            </p>
          </div>
          <% } %>
        </div>

        <div class="glass-panel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold m-0">
              <i class="fa-solid fa-paper-plane me-2" style="color: #a855f7"></i
              >Recent Posts
            </h5>
          </div>

          <% if(user.posts && user.posts.length > 0) { %>
          <div class="row g-3">
            <% user.posts.slice().reverse().forEach(post => { %>
            <div class="col-12">
              <div
                class="p-3 rounded-4 border border-white border-opacity-5"
                style="background: rgba(255, 255, 255, 0.02)"
              >
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="text-white fw-bold mb-0"><%= post.title %></h6>
                  <span class="small text-purple fw-bold opacity-75"
                    ><%= post.category %></span
                  >
                </div>
                <p class="text-secondary small mb-0">
                  <%= post.content.substring(0, 120) %>...
                </p>
              </div>
            </div>
            <% }) %>
          </div>
          <% } else { %>
          <div class="text-center py-4 text-secondary opacity-50">
            <p class="small mb-0">
              You haven't shared any post in community yet.
            </p>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const canvas = document.getElementById("glitterCanvas");
  const ctx = canvas.getContext("2d");

  let particles = [];
  const colors = ["#a855f7", "#ec4899", "#6366f1", "#3b82f6"];

  function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    particles = [];
    for (let i = 0; i < 90; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 4 + 1,
        dx: (Math.random() - 0.5) * 0.8,
        dy: (Math.random() - 0.5) * 0.8,
        color: colors[Math.floor(Math.random() * colors.length)],
      });
    }
  }

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach((p) => {
      // Draw 3D-like shaded sphere
      let gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
      gradient.addColorStop(0, "white");
      gradient.addColorStop(0.4, p.color);
      gradient.addColorStop(1, "transparent");

      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();

      // Movement logic
      p.x += p.dx;
      p.y += p.dy;

      // Bounce off edges
      if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
    });
    requestAnimationFrame(animate);
  }

  window.addEventListener("resize", init);
  init();
  animate();
</script>
